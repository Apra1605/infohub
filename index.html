<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gemini Report Generator</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1f2937, #111827);
      color: #f9fafb;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: #1f2937;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      width: 100%;
      max-width: 600px;
      text-align: center;
    }
    h1 {
      margin-bottom: 1rem;
      font-size: 1.75rem;
      color: #fbbf24;
    }
    textarea {
      width: 100%;
      height: 120px;
      padding: 1rem;
      border-radius: 0.75rem;
      border: none;
      resize: vertical;
      font-size: 1rem;
      margin-bottom: 1rem;
      outline: none;
    }
    button {
      background: #fbbf24;
      color: #111827;
      font-weight: bold;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    button:hover {
      background: #f59e0b;
    }
    .status {
      margin-top: 1rem;
      font-size: 0.95rem;
      min-height: 1.25rem;
    }
    .error {
      color: #f87171;
      margin-top: 0.5rem;
      white-space: pre-wrap;
      text-align: left;
      font-size: 0.85rem;
      background: #b91c1c33;
      padding: 0.75rem;
      border-radius: 0.5rem;
      max-height: 200px;
      overflow-y: auto;
    }
    .loader {
      display: none;
      margin: 1rem auto;
      width: 48px;
      height: 48px;
      border: 5px solid #fbbf24;
      border-top: 5px solid transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Report Generator</h1>
    <textarea id="query" placeholder="Enter a query (e.g. 'Elon Musk background report')..."></textarea>
    <button onclick="generate()">Generate Report</button>
    <div class="loader" id="loader"></div>
    <div id="status" class="status"></div>
    <div id="errorLog" class="error" style="display:none;"></div>
  </div>

  <script>
    const GEMINI_API_KEY = "AIzaSyDtkfMLw-k9-Evqy_ncEin8n0xel1eu1cE";
    const GEMINI_MODEL = "gemini-2.0-flash";

    const statusEl = document.getElementById('status');
    const errorLog = document.getElementById('errorLog');
    const loader = document.getElementById('loader');

    let lastReportHTML = "";

    function setStatus(msg) { statusEl.textContent = msg; }
    function logError(msg) {
      console.error(msg);
      errorLog.style.display = 'block';
      errorLog.textContent += `\n${msg}`;
    }

    // ✅ RapidAPI Google Search with required header
    function fetchSearchResults(query) {
      return new Promise((resolve) => {
        const data = null;
        const xhr = new XMLHttpRequest();
        xhr.withCredentials = true;

        xhr.addEventListener("readystatechange", function () {
          if (this.readyState === this.DONE) {
            try {
              const res = JSON.parse(this.responseText);
              const results = res.results?.map(r => `- ${r.title}: ${r.description || ""} (URL: ${r.url})`).join("\n");
              resolve(results || "No results.");
            } catch (err) {
              logError("Search parse error: " + err.message);
              resolve("No results (parse failed).");
            }
          }
        });

        xhr.open("GET", `https://google-search74.p.rapidapi.com/?query=${encodeURIComponent(query)}&limit=10&related_keywords=true`);
        xhr.setRequestHeader("x-rapidapi-key", "6686103cf4mshbea57d107efd876p1a922bjsndcaa4bca1a70");
        xhr.setRequestHeader("x-rapidapi-host", "google-search74.p.rapidapi.com");
        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest"); // ✅ fix for 401
        xhr.send(data);
      });
    }

    function buildPrompt(query, searchResults) {
      return `You are an assistant that must output ONLY a complete, valid HTML5 document. The HTML must be self-contained with inline CSS, no external links or markdown fences.
      It must look like a professional police background search report with modern styling, structured boxes, tables, and images if relevant. Information needs to be exact.
      Use paragraphs a lot for more information (still organized). Do not generalize! Unknown information should be intently researched. The information should be a lot!!!
      Include all history and all information. Gather as much detailed, organized information about the query as possible and present it inside this HTML page. All information collected should be fact-checked!
      Inaccurate information will not be tolerated! After getting the information or generating the code for the website, double-check the code and information for placeholders and false information.
      Do not include explanations, markdown, or anything else — ONLY the HTML code.

Query: ${query}

Web Search Results:
${searchResults}`;
    }

    function stripCodeFences(text) {
      return text.replace(/^\s*```(?:html)?/i, '')
                 .replace(/```\s*$/i, '')
                 .trim();
    }

    function getFirstText(data) {
      return data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
    }

    async function generate() {
      const q = document.getElementById('query').value.trim();
      if (!q) { setStatus('Enter a query.'); return; }
      errorLog.style.display = 'none';
      errorLog.textContent = '';
      loader.style.display = 'block';
      setStatus('Searching...');

      try {
        const searchResults = await fetchSearchResults(q);

        setStatus('Generating...');
        const body = { contents: [{ role: 'user', parts: [{ text: buildPrompt(q, searchResults) }] }],
                       generationConfig: { temperature: 0.5, maxOutputTokens: 6000 } };

        const res = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${encodeURIComponent(GEMINI_API_KEY)}`,
          { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }
        );

        if (!res.ok) { logError(await res.text()); setStatus('Error'); loader.style.display='none'; return; }

        const data = await res.json();
        const text = getFirstText(data);
        if (!text) { logError('Empty response text.'); setStatus('Error'); loader.style.display='none'; return; }

        const htmlRaw = stripCodeFences(text);
        lastReportHTML = htmlRaw;
        const blob = new Blob([htmlRaw], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');

        setStatus('Report opened in new tab.');
      } catch (err) {
        logError(err.stack || err);
        setStatus('Error');
      } finally {
        loader.style.display = 'none';
      }
    }
  </script>
</body>
</html>
