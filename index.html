<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gemini Report Generator</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1f2937, #111827);
      color: #f9fafb;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: #1f2937;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      width: 100%;
      max-width: 600px;
      text-align: center;
    }
    h1 {
      margin-bottom: 1rem;
      font-size: 1.75rem;
      color: #fbbf24;
    }
    textarea {
      width: 100%;
      height: 120px;
      padding: 1rem;
      border-radius: 0.75rem;
      border: none;
      resize: vertical;
      font-size: 1rem;
      margin-bottom: 1rem;
      outline: none;
    }
    button {
      background: #fbbf24;
      color: #111827;
      font-weight: bold;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    button:hover {
      background: #f59e0b;
    }
    .status {
      margin-top: 1rem;
      font-size: 0.95rem;
      min-height: 1.25rem;
    }
    .error {
      color: #f87171;
      margin-top: 0.5rem;
      white-space: pre-wrap;
      text-align: left;
      font-size: 0.85rem;
      background: #b91c1c33;
      padding: 0.75rem;
      border-radius: 0.5rem;
      max-height: 200px;
      overflow-y: auto;
    }
    .loader {
      display: none;
      margin: 1rem auto;
      width: 48px;
      height: 48px;
      border: 5px solid #fbbf24;
      border-top: 5px solid transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .popup-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #fbbf24;
      color: #111827;
      border: none;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      z-index: 999;
      transition: transform 0.2s;
    }
    .popup-btn:hover { transform: scale(1.1); }
    .side-bar {
      position: fixed;
      top: 0;
      right: -350px;
      width: 350px;
      height: 100%;
      background: #111827;
      box-shadow: -4px 0 16px rgba(0,0,0,0.6);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      transition: right 0.4s ease;
      z-index: 998;
    }
    .side-bar.open { right: 0; }
    .side-bar h2 { color: #fbbf24; font-size: 1.2rem; margin-bottom: 1rem; }
    .side-bar textarea { flex-grow: 1; resize: none; margin-bottom: 0.75rem; }
    .side-bar button { margin-top: auto; }
    .side-bar .response {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      background: #1f2937;
      font-size: 0.9rem;
      overflow-y: auto;
      max-height: 200px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gemini Report Generator</h1>
    <textarea id="query" placeholder="Enter a query (e.g. 'Elon Musk background report')..."></textarea>
    <button onclick="generate()">Generate Report</button>
    <div class="loader" id="loader"></div>
    <div id="status" class="status"></div>
    <div id="errorLog" class="error" style="display:none;"></div>
  </div>

  <script>
    const GEMINI_API_KEY = "AIzaSyDtkfMLw-k9-Evqy_ncEin8n0xel1eu1cE";
    const GEMINI_MODEL = "gemini-2.0-flash";
    const SERPAPI_KEY = "3bcc804bc33faea1e8fa694e7db1db2caa6a1e9aa412d6189d951d14f68aa50c"; // ðŸ”‘ Put your SerpAPI key here

    const statusEl = document.getElementById('status');
    const errorLog = document.getElementById('errorLog');
    const loader = document.getElementById('loader');

    let lastReportHTML = "";

    function setStatus(msg) { statusEl.textContent = msg; }
    function logError(msg) {
      console.error(msg);
      errorLog.style.display = 'block';
      errorLog.textContent += `\n${msg}`;
    }

    async function fetchSearchResults(query) {
      try {
        const res = await fetch(`https://serpapi.com/search.json?engine=google&q=${encodeURIComponent(query)}&api_key=${SERPAPI_KEY}`);
        if (!res.ok) throw new Error("Search API error: " + res.status);
        const data = await res.json();
        return data.organic_results?.map(r => `- ${r.title}: ${r.snippet || ""} (URL: ${r.link})`).join("\n") || "No results.";
      } catch (e) {
        logError("Search error: " + e.message);
        return "No results (search failed).";
      }
    }

    function buildPrompt(query, searchResults) {
      return `You are an assistant that must output ONLY a complete, valid HTML5 document. The HTML must be self-contained with inline CSS, no external links or markdown fences.
      It must look like a professional police background search report with modern styling, structured boxes, tables, and images if relevant. Information needs to be exact.
      Use paragraphs a lot for more information (still organized). Do not generalize! Unknown information should be intently researched. The information should be a lot!!!
      Include all history and all information. Gather as much detailed, organized information about the query as possible and present it inside this HTML page. All information collected should be fact-checked!
      Inaccurate information will not be tolerated! After getting the information or generating the code for the website, double-check the code and information for placeholders and false information.
      Do not include explanations, markdown, or anything else â€” ONLY the HTML code.

Query: ${query}

Web Search Results:
${searchResults}`;
    }

    function buildFollowUpPrompt(query) {
      return `You are continuing from the following report HTML content (context background):
---
${lastReportHTML}
---
If the query asks for information not in the report then search up the information and give that information!
You are expected to be accurate, useful, detailed, and knowledgeable.
Now, answer this follow-up query in detail, factually, and concisely:
${query}`;
    }

    function stripCodeFences(text) {
      return text.replace(/^\s*```(?:html)?/i, '')
                 .replace(/```\s*$/i, '')
                 .trim();
    }

    function getFirstText(data) {
      return data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
    }

    async function generate() {
      const q = document.getElementById('query').value.trim();
      if (!q) { setStatus('Enter a query.'); return; }
      errorLog.style.display = 'none';
      errorLog.textContent = '';
      loader.style.display = 'block';
      setStatus('Searching...');

      try {
        const searchResults = await fetchSearchResults(q);

        setStatus('Generating...');
        const body = { contents: [{ role: 'user', parts: [{ text: buildPrompt(q, searchResults) }] }],
                       generationConfig: { temperature: 0.5, maxOutputTokens: 6000 } };

        const res = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${encodeURIComponent(GEMINI_API_KEY)}`,
          { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }
        );

        if (!res.ok) { logError(await res.text()); setStatus('Error'); loader.style.display='none'; return; }

        const data = await res.json();
        const text = getFirstText(data);
        if (!text) { logError('Empty response text.'); setStatus('Error'); loader.style.display='none'; return; }

        const htmlRaw = stripCodeFences(text);
        lastReportHTML = htmlRaw;
        const blob = new Blob([htmlRaw + popupTemplate()], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');

        setStatus('Report opened in new tab.');
      } catch (err) {
        logError(err.stack || err);
        setStatus('Error');
      } finally {
        loader.style.display = 'none';
      }
    }

    function popupTemplate() {
      return `
        <button class="popup-btn" onclick="document.querySelector('.side-bar').classList.toggle('open')">+</button>
        <div class="side-bar">
          <h2>Ask AI</h2>
          <textarea id="followupQuery" placeholder="Ask about this report..."></textarea>
          <button onclick="sendFollowUp()">Send</button>
          <div id="followupLoader" class="loader"></div>
          <div class="response" id="followupResponse"></div>
        </div>
        <script>
          async function sendFollowUp(){
            const q=document.getElementById('followupQuery').value.trim();
            if(!q) return;
            const loader=document.getElementById('followupLoader');
            const respBox=document.getElementById('followupResponse');
            loader.style.display='block'; respBox.textContent='';
            try{
              const body={contents:[{role:'user',parts:[{text:\`${buildFollowUpPrompt('${q}')}\`}]}],
                          generationConfig:{temperature:0.5,maxOutputTokens:2000}};
              const res=await fetch('https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${encodeURIComponent(GEMINI_API_KEY)}',
                                    {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
              if(!res.ok){respBox.textContent='Error: '+(await res.text()); return;}
              const data=await res.json();
              const text=data?.candidates?.[0]?.content?.parts?.[0]?.text||'No response';
              respBox.textContent=text;
            }catch(e){respBox.textContent='Error: '+e;}
            finally{loader.style.display='none';}
          }
        <\/script>`;
    }
  </script>
</body>
</html>
